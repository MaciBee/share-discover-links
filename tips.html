<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Tips/Thoughts</title>
    <style>
        body { font-family: Open Sans, sans-serif; padding: 20px; background-color: #ffffff; color: ##eaeaea; }
        h1, h2, p { color: #000000; }
        div.tip { margin-bottom: 20px; padding: 10px; background-color: #ffffff; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        div.comment { margin-left: 20px; padding: 5px; border-left: 2px solid #eaeaea; }
        .hidden { display: none; }
        textarea, input[type="text"] { width: 95%; padding: 8px; margin-top: 5px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; }
        textarea { height: 80px; }
        button:hover { background-color: #ffecef; }
        .comment-form, .comments-container { margin-top: 10px; }
    </style>
</head>
<body>
<center>    <h1>Capture Fleeting Thoughts</h1> </center>
<center><p> A junk drawer of ideas to revisit later. If you like, share what's on your mind by submitting your thoughts :) </p></center>

    <form id="tipForm">
        <input type="text" name="title" placeholder="Title" required><br>
        <textarea name="description" placeholder="Description" required></textarea><br>
    <div style="display: flex; justify-content: space-between;">
        <input type="text" name="category" placeholder="Category"><br>
        <input type="text" name="author" placeholder="Author" required><br>
</div><br>
        <button type="submit">Submit</button>
    </form>

    <h2>Explore Random Thoughts</h2>
    <div id="tipsContainer"></div>

    <script>
    document.addEventListener('DOMContentLoaded', function() {
        const tipForm = document.getElementById('tipForm');
        const tipsContainer = document.getElementById('tipsContainer');

        tipForm.addEventListener('submit', function(event) {
            event.preventDefault();
            const formData = new FormData(tipForm);
            fetch('http://autodidacting.org:3002/tips', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    title: formData.get('title'),
                    description: formData.get('description'),
                    category: formData.get('category'),
                    author: formData.get('author')
                })
            })
            .then(response => response.json())
            .then(data => {
                fetchTips(); // Refresh the list of tips after adding a new one
                tipForm.reset();
            })
            .catch(error => {
                console.error('Error submitting tip:', error);
                alert('Failed to submit tip: ' + error.message);
            });
        });

        function fetchTips() {
            fetch('http://autodidacting.org:3002/tips')
            .then(response => response.json())
            .then(tips => {
                tipsContainer.innerHTML = ''; // Clear existing tips
                tips.forEach(tip => {
                    const div = document.createElement('div');
                    div.className = 'tip';
                    div.innerHTML = `
                        <h3>${tip.title}</h3>
                        <p>${tip.description}</p>
                        <p>Category: ${tip.category}</p>
                        <p>Author: ${tip.author}</p>
                        <button onclick="toggleCommentForm(${tip.id})">Leave a Comment</button>
                        <button onclick="toggleComments(${tip.id})">Show Comments</button>
                        <div id='comments_${tip.id}' class='comments-container hidden'></div>
                        <div class="comment-form hidden" id='commentForm_${tip.id}'>
                            <textarea id='commentText_${tip.id}' placeholder='Your comment' required></textarea>
                            <input type='text' id='commentAuthor_${tip.id}' placeholder='Your name (optional)'>
                            <button onclick='submitComment(event, ${tip.id})'>Post Comment</button>
                        </div>
                    `;
                    tipsContainer.appendChild(div);
                });
            })
            .catch(error => {
                console.error('Failed to fetch tips:', error);
            });
        }

        window.toggleCommentForm = function(tipId) {
            var form = document.getElementById('commentForm_' + tipId);
            form.classList.toggle('hidden');
        };

        window.toggleComments = function(tipId) {
            var comments = document.getElementById(`comments_${tipId}`);
            comments.classList.toggle('hidden');
            if (!comments.classList.contains('hidden') && comments.innerHTML === '') {
                fetchComments(tipId);
            }
        };

        window.submitComment = function(event, tipId) {
            event.preventDefault();
            const commentText = document.getElementById('commentText_' + tipId).value;
            const author = document.getElementById('commentAuthor_' + tipId).value || '';
            fetch(`http://autodidacting.org:3002/comments`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    tip_id: tipId,
                    comment_text: commentText,
                    author: author.trim() // Sending author name if provided
                })
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Failed to post comment. Status: ' + response.status);
                }
                return response.json();
            })
            .then(comment => {
                document.getElementById('commentText_' + tipId).value = ''; // Reset comment input
                document.getElementById('commentAuthor_' + tipId).value = ''; // Reset author input
                fetchComments(tipId); // Refresh comments for the tip
            })
            .catch(error => {
                console.error('Error posting comment:', error);
                alert('Failed to post comment: ' + error.message);
            });
        };

        function fetchComments(tipId) {
            fetch(`http://autodidacting.org:3002/comments/${tipId}`)
            .then(response => response.json())
            .then(comments => {
                const commentsContainer = document.getElementById(`comments_${tipId}`);
                commentsContainer.innerHTML = ''; // Clear previous comments
                comments.forEach(comment => {
                    const commentDiv = document.createElement('div');
                    commentDiv.className = 'comment';
                    commentDiv.innerHTML = `<p>${comment.comment_text} ${comment.author ? '- ' + comment.author : ''}</p>`;
                    commentsContainer.appendChild(commentDiv);
                });
            })
            .catch(error => {
                console.error(`Error fetching comments for tip ${tipId}:`, error);
            });
        }

        fetchTips(); // Fetch and display tips on page load
    });
    </script>
</body>
</html>
